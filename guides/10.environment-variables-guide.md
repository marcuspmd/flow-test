# Guia de Vari√°veis de Ambiente - Flow Test Engine

Este guia explica como configurar e usar vari√°veis de ambiente no Flow Test Engine.

## üìã √çndice

- [Configura√ß√£o B√°sica](#configura√ß√£o-b√°sica)
- [Carregamento Autom√°tico via Config](#carregamento-autom√°tico-via-config)
- [Uso em YAML](#uso-em-yaml)
- [M√∫ltiplos Arquivos .env](#m√∫ltiplos-arquivos-env)
- [Ordem de Preced√™ncia](#ordem-de-preced√™ncia)
- [Boas Pr√°ticas](#boas-pr√°ticas)
- [Exemplos Pr√°ticos](#exemplos-pr√°ticos)

---

## Configura√ß√£o B√°sica

### 1. Criar arquivo .env

```bash
# Copiar o template
cp .env.example .env

# Editar com suas credenciais
nano .env
```

### 2. Configurar no flow-test.config.yml

```yaml
globals:
  # Especificar arquivos .env para carregar automaticamente
  env_files:
    - .env              # Arquivo principal
    - .env.local        # Sobrescritas locais (gitignore)
    - .env.test         # Espec√≠fico para ambiente de teste
```

### 3. Definir vari√°veis no .env

```bash
# IMPORTANTE: Usar prefixo FLOW_TEST_
FLOW_TEST_API_BASE_URL=https://api.example.com
FLOW_TEST_OAUTH_USERNAME=my_client_id
FLOW_TEST_OAUTH_PASSWORD=my_secret
FLOW_TEST_PEM_PASSWORD=cert_password
```

---

## Carregamento Autom√°tico via Config

O Flow Test Engine carrega automaticamente os arquivos `.env` especificados em `globals.env_files`:

```yaml
# flow-test.config.yml
project_name: "My API Tests"
test_directory: ./tests

globals:
  env_files:
    - .env                  # Carregado primeiro
    - .env.local            # Sobrescreve valores do .env
    - .env.{{environment}}  # Din√¢mico baseado em vari√°vel

  variables:
    # Vari√°veis podem usar valores do .env
    api_url: "{{$env.API_BASE_URL}}"
    username: "{{$env.OAUTH_USERNAME}}"
```

### Caracter√≠sticas:

- ‚úÖ **Carregamento autom√°tico** no in√≠cio da execu√ß√£o
- ‚úÖ **Ordem de carregamento** respeita a sequ√™ncia definida
- ‚úÖ **Sobrescrita de valores** - arquivos posteriores sobrescrevem anteriores
- ‚úÖ **Caminhos relativos** - relativos √† raiz do projeto
- ‚úÖ **Logs informativos** - avisa quando arquivo n√£o √© encontrado
- ‚úÖ **Tolerante a falhas** - continua mesmo se arquivo n√£o existir

---

## Uso em YAML

### Sintaxe de Interpola√ß√£o

```yaml
# Formato: {{$env.NOME_DA_VARIAVEL}}
# IMPORTANTE: Remover o prefixo FLOW_TEST_ ao usar

# .env cont√©m:
# FLOW_TEST_API_KEY=abc123
# FLOW_TEST_USERNAME=admin

suite_name: "API Tests"
base_url: "{{$env.API_BASE_URL}}"  # L√™ FLOW_TEST_API_BASE_URL

steps:
  - name: "Login"
    request:
      method: POST
      url: "/auth/login"
      headers:
        X-API-Key: "{{$env.API_KEY}}"  # L√™ FLOW_TEST_API_KEY
      body:
        username: "{{$env.USERNAME}}"   # L√™ FLOW_TEST_USERNAME
        password: "{{$env.PASSWORD}}"   # L√™ FLOW_TEST_PASSWORD
```

### Certificados com Senhas do .env

```yaml
# .env
FLOW_TEST_PEM_PASSWORD=my_certificate_password

# YAML
suite_name: "Secure API Tests"
certificate:
  cert_path: "./certs/client.pem"
  passphrase: "{{$env.PEM_PASSWORD}}"  # ‚úÖ SEGURO

# NUNCA fa√ßa:
# passphrase: "my_certificate_password"  # ‚ùå INSEGURO
```

---

## M√∫ltiplos Arquivos .env

### Estrat√©gia de Ambientes

```yaml
# flow-test.config.yml
globals:
  env_files:
    - .env              # Valores padr√£o para todos os ambientes
    - .env.local        # Sobrescritas do desenvolvedor (gitignore)
    - .env.test         # Valores espec√≠ficos para testes
```

### Estrutura de Arquivos

```bash
project/
‚îú‚îÄ‚îÄ .env                # Commitado - valores p√∫blicos/defaults
‚îú‚îÄ‚îÄ .env.local          # Gitignore - valores locais do dev
‚îú‚îÄ‚îÄ .env.test           # Commitado - valores para CI/CD
‚îú‚îÄ‚îÄ .env.staging        # Commitado - valores de staging
‚îú‚îÄ‚îÄ .env.production     # Commitado - refer√™ncias (sem secrets)
‚îî‚îÄ‚îÄ .env.example        # Template para novos devs
```

### Exemplo de Arquivos

**`.env` (commitado):**
```bash
FLOW_TEST_API_BASE_URL=http://localhost:3000
FLOW_TEST_ENVIRONMENT=development
```

**`.env.local` (gitignore):**
```bash
# Sobrescrever para desenvolvimento local
FLOW_TEST_API_BASE_URL=http://localhost:8080
FLOW_TEST_OAUTH_USERNAME=local_dev_user
FLOW_TEST_OAUTH_PASSWORD=local_dev_password
FLOW_TEST_PEM_PASSWORD=local_cert_pass
```

**`.env.test` (commitado - CI/CD):**
```bash
FLOW_TEST_API_BASE_URL=https://api-test.example.com
FLOW_TEST_ENVIRONMENT=test
# Usar secrets do CI para senhas
```

---

## Ordem de Preced√™ncia

A ordem de aplica√ß√£o de valores (maior para menor prioridade):

1. **Vari√°veis de ambiente do sistema** (j√° definidas antes da execu√ß√£o)
2. **Arquivos .env** (em ordem de carregamento - √∫ltimos sobrescrevem)
3. **Vari√°veis definidas em `globals.variables`**
4. **Valores padr√£o no c√≥digo**

### Exemplo:

```bash
# Sistema j√° tem:
export FLOW_TEST_API_URL=https://prod.api.com

# .env cont√©m:
FLOW_TEST_API_URL=https://dev.api.com

# .env.local cont√©m:
FLOW_TEST_API_URL=https://localhost:8080

# Config tem:
globals:
  env_files:
    - .env
    - .env.local
  variables:
    api_url: "{{$env.API_URL}}"

# Resultado final:
# api_url = https://localhost:8080 (do .env.local)
# Mas se FLOW_TEST_API_URL j√° estivesse no sistema, usaria o valor do sistema
```

---

## Boas Pr√°ticas

### ‚úÖ DO (Fa√ßa):

```yaml
# 1. Use sempre {{$env.VAR}} para dados sens√≠veis
certificate:
  passphrase: "{{$env.PEM_PASSWORD}}"

# 2. Prefixe sempre com FLOW_TEST_
FLOW_TEST_API_KEY=abc123

# 3. Documente vari√°veis obrigat√≥rias no .env.example
# FLOW_TEST_API_KEY=your_api_key_here  # Obrigat√≥rio

# 4. Use .env.local para desenvolvimento local
# (adicione ao .gitignore)

# 5. Configure env_files no flow-test.config.yml
globals:
  env_files:
    - .env
    - .env.local
```

### ‚ùå DON'T (N√£o Fa√ßa):

```yaml
# 1. NUNCA hardcode secrets
certificate:
  passphrase: "my_password"  # ‚ùå INSEGURO

# 2. NUNCA commite .env com secrets
# Adicione ao .gitignore:
.env
.env.local
.env.*.local

# 3. NUNCA use vari√°veis sem prefixo (n√£o ser√£o reconhecidas)
API_KEY=abc123  # ‚ùå Deve ser FLOW_TEST_API_KEY

# 4. NUNCA misture ambientes em um arquivo
# Use arquivos separados (.env.test, .env.staging)
```

### .gitignore Recomendado

```gitignore
# Environment files
.env
.env.local
.env.*.local

# Mant√©m os templates
!.env.example
!.env.test
!.env.staging
```

---

## Exemplos Pr√°ticos

### Exemplo 1: OAuth2 com Certificado

**`.env`:**
```bash
FLOW_TEST_TOKEN_BASE_URL=https://auth.api.example.com
FLOW_TEST_OAUTH_USERNAME=client_id_12345
FLOW_TEST_OAUTH_PASSWORD=client_secret_xyz789
FLOW_TEST_PEM_PASSWORD=cert_password
```

**`flow-test.config.yml`:**
```yaml
globals:
  env_files:
    - .env
    - .env.local
```

**`oauth2-token.yaml`:**
```yaml
suite_name: "OAuth2 Authentication"
base_url: "{{$env.TOKEN_BASE_URL}}"

certificate:
  cert_path: "./certs/client.pem"
  passphrase: "{{$env.PEM_PASSWORD}}"

steps:
  - name: "Get Token"
    request:
      method: POST
      url: "/token"
      params:
        grant_type: "client_credentials"
      headers:
        Authorization: "Basic {{$js:Buffer.from('{{$env.OAUTH_USERNAME}}:{{$env.OAUTH_PASSWORD}}').toString('base64')}}"
    capture:
      access_token: "body.access_token"
```

### Exemplo 2: M√∫ltiplos Ambientes

**`flow-test.config.yml`:**
```yaml
globals:
  env_files:
    - .env
    - .env.{{$env.ENVIRONMENT}}  # Din√¢mico
    - .env.local                  # Sempre por √∫ltimo

  variables:
    api_url: "{{$env.API_BASE_URL}}"
    environment: "{{$env.ENVIRONMENT}}"
```

**Executar em diferentes ambientes:**
```bash
# Development (usa .env.development)
FLOW_TEST_ENVIRONMENT=development npm start

# Test (usa .env.test)
FLOW_TEST_ENVIRONMENT=test npm test

# Staging (usa .env.staging)
FLOW_TEST_ENVIRONMENT=staging npm run test:staging
```

### Exemplo 3: CI/CD (GitHub Actions)

**`.github/workflows/test.yml`:**
```yaml
name: Run API Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        env:
          FLOW_TEST_API_BASE_URL: ${{ secrets.API_BASE_URL }}
          FLOW_TEST_OAUTH_USERNAME: ${{ secrets.OAUTH_USERNAME }}
          FLOW_TEST_OAUTH_PASSWORD: ${{ secrets.OAUTH_PASSWORD }}
          FLOW_TEST_PEM_PASSWORD: ${{ secrets.PEM_PASSWORD }}
        run: npm test
```

**`flow-test.config.yml` (mesma config funciona em CI):**
```yaml
globals:
  env_files:
    - .env.test  # Valores n√£o-sens√≠veis para CI

  # Secrets v√™m das vari√°veis de ambiente do GitHub
```

### Exemplo 4: Fallback com Valores Padr√£o

```yaml
# .env.example (commitado)
FLOW_TEST_API_BASE_URL=http://localhost:3000
FLOW_TEST_TIMEOUT=30000

# YAML com fallbacks
suite_name: "API Tests"
base_url: "{{$env.API_BASE_URL}}"  # Fallback para localhost se n√£o definido

variables:
  # Se FLOW_TEST_CUSTOM_HEADER n√£o existir, usa valor padr√£o
  custom_header: "{{$env.CUSTOM_HEADER}}"
  timeout: "{{$env.TIMEOUT}}"

steps:
  - name: "Test endpoint"
    request:
      url: "/api/test"
      timeout: "{{timeout}}"
```

---

## Troubleshooting

### Problema: Vari√°vel n√£o est√° sendo reconhecida

```bash
# ‚ùå Erro: Vari√°vel n√£o encontrada
API_KEY=abc123

# ‚úÖ Solu√ß√£o: Adicionar prefixo FLOW_TEST_
FLOW_TEST_API_KEY=abc123
```

### Problema: .env n√£o est√° sendo carregado

```yaml
# ‚ùå Falta configura√ß√£o no flow-test.config.yml
globals:
  variables:
    api_key: "{{$env.API_KEY}}"

# ‚úÖ Adicionar env_files
globals:
  env_files:
    - .env
  variables:
    api_key: "{{$env.API_KEY}}"
```

### Problema: Valor errado sendo usado

```bash
# Verificar ordem de preced√™ncia:
# 1. Vari√°vel j√° existe no sistema?
echo $FLOW_TEST_API_URL

# 2. Qual arquivo .env foi carregado por √∫ltimo?
# Verificar ordem em globals.env_files

# 3. Arquivo existe e tem permiss√µes corretas?
ls -la .env .env.local
```

### Debug de Vari√°veis

```yaml
# Adicionar step de debug
steps:
  - name: "Debug environment"
    request:
      method: GET
      url: "/debug"
    capture:
      debug_api_url: "{{$env.API_BASE_URL}}"
      debug_username: "{{$env.OAUTH_USERNAME}}"
      # Capturar para ver valores resolvidos
```

---

## Recursos Adicionais

- üìñ [Documenta√ß√£o de Certificados](./certificates-guide.md)
- üìñ [AGENTS.md](../AGENTS.md) - Refer√™ncia completa de propriedades
- üìñ [Exemplos de Testes](../tests/)
- üîß [flow-test.config.yml](../flow-test.config.yml) - Configura√ß√£o de exemplo

---

## Suporte

Encontrou algum problema ou tem sugest√µes? Abra uma issue no reposit√≥rio!
