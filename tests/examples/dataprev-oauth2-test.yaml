suite_name: "Dataprev OAuth2 Test"
node_id: "dataprev-oauth2-test"
description: "Teste de autenticação OAuth2 com Dataprev"

base_url: "{{$env.DATAPREV_TOKEN_URL}}"

# Variáveis da suite - NÃO TENTE INTERPOLAR JS AQUI
variables:
  env_username: "{{$env.DATAPREV_USERNAME}}"
  env_password: "{{$env.DATAPREV_PASSWORD}}"

# ⚠️ IMPORTANTE: Use variável de ambiente com CAMINHO ABSOLUTO para evitar problemas
# Exemplo no .env: FLOW_TEST_DATAPREV_CERT_PATH=/Users/marcusp/Documents/flow-test/certs/dataprev.pem
certificate:
  cert_path: "{{$env.DATAPREV_CERT_PATH}}"
  passphrase: "{{$env.DATAPREV_PEM_PASSWORD}}"
  # Desabilitar verificação SSL (como no PHP 'verify' => false)
  verify: false

exports: ["access_token", "token_type", "expires_in"]

metadata:
  priority: "critical"
  tags: ["dataprev", "oauth2"]

steps:
  - name: "Request OAuth2 Token"
    step_id: "get-token"

    request:
      method: POST
      url: "/token?grant_type=client_credentials"

      headers:
        # ✅ CORRETO: Interpolação aninhada diretamente no header
        Authorization: "Basic {{$js:Buffer.from('{{env_username}}:{{env_password}}').toString('base64')}}"
        Accept: "*/*"
        Content-Type: "application/x-www-form-urlencoded"

      body: "grant_type=client_credentials"

      timeout: 20000

    assert:
      status_code: 200

      body:
        access_token:
          exists: true
          type: "string"
          notEmpty: true

        token_type:
          exists: true
          equals: "Bearer"

        expires_in:
          exists: true
          type: "number"
          greater_than: 0

    capture:
      access_token: "body.access_token"
      token_type: "body.token_type"
      expires_in: "body.expires_in"

    metadata:
      description: "Obtém token OAuth2 da Dataprev"
      retry:
        max_attempts: 3
        delay_ms: 2000
