node_id: "environment-variables"
suite_name: "Environment Variables Integration Test"
description: "Tests environment variable loading and hierarchical scoping resolution"
base_url: "{{httpbin_url}}"

metadata:
  priority: "medium"
  tags: ["environment", "variables", "scoping", "system"]
  estimated_duration_ms: 3000

variables:
  local_var: "local_value"
  override_test: "suite_level"

steps:
  - name: "Test environment variable access"
    request:
      method: "POST"
      url: "/post"
      headers:
        Content-Type: "application/json"
        X-User: "{{$env.USER}}"
        X-Home: "{{$env.HOME}}"
      body:
        user: "{{$env.USER}}"
        home_exists: "{{$env.HOME}}"
        path_exists: "{{$env.PATH}}"
        custom_env: "{{$env.FLOW_TEST_CUSTOM}}"
    assert:
      status_code: 200
      body:
        headers:
          X-User:
            exists: true
    capture:
      env_user: "body.data | fromjson | @.user"
      env_home: "body.data | fromjson | @.home_exists"

  - name: "Test variable hierarchy resolution"
    request:
      method: "POST"
      url: "/post"
      headers:
        Content-Type: "application/json"
      body:
        local_value: "{{local_var}}"
        env_value: "{{$env.FLOW_TEST_OVERRIDE}}"
        mixed_resolution: "User: {{$env.USER}}, Local: {{local_var}}"
        hierarchy_test: "{{override_test}}"
    assert:
      status_code: 200
      body:
        data:
          contains: "local_value"

  - name: "Test environment variable defaults"
    request:
      method: "GET"
      url: "/get"
      headers:
        X-Env-Default: "{{$env.NONEXISTENT_VAR}}"
        X-With-Default: "default_value"  # Usar valor fixo em vez de sintaxe bash
    assert:
      status_code: 200
      body:
        headers:
          X-With-Default:
            equals: "default_value"

  - name: "Test environment in scenarios"
    request:
      method: "GET"
      url: "/get"
    scenarios:
      - name: "Environment-based conditional"
        condition: "status_code == `200`"  # Mudança para condição mais simples
        then:
          capture:
            env_conditional_result: "`test_passed`"
          variables:
            env_test_passed: true
        else:
          variables:
            env_test_passed: false

exports:
  - env_user
  - env_home
  - env_test_passed