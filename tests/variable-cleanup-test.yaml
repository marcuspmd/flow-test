# Teste de Limpeza de Variáveis entre Nodes
suite_name: "Teste de Limpeza de Variáveis entre Nodes"
node_id: "variable_cleanup_test"
description: "Valida que variáveis não-globais são limpas entre diferentes nodes"
priority: "high"

base_url: "{{httpbin_url}}"

# Este teste depende do node variable_interpolation para testar a limpeza
depends:
  - node_id: "variable_interpolation"
    required: true

variables:
  cleanup_test_var: "cleanup_value"
  local_test_value: 123

exports:
  - cleanup_verification_result
  - variable_state_before
  - variable_state_after

steps:
  # Teste 1: Verificar estado das variáveis antes da limpeza (deve falhar por design)
  - name: "Verify Variables Before Cleanup"
    request:
      method: POST
      url: "/post"
      headers:
        Content-Type: "application/json"
      body:
        test_context: "before_cleanup"
        # Tentar acessar variáveis do node anterior - devem estar LIMPAS (comportamento correto)
        previous_user_id: "{{user_id}}"  # Deve ficar como {{user_id}} pois foi limpa
        previous_user_name: "{{user_name}}"  # Deve ficar como {{user_name}} pois foi limpa
        previous_company_data: "{{company_data}}"  # Deve ficar como {{company_data}} pois foi limpa
        local_variables:
          cleanup_test_var: "{{cleanup_test_var}}"
          local_test_value: "{{local_test_value}}"

    assert:
      status_code: 200
      body:
        json.previous_user_id:
          equals: "{{user_id}}"  # Deve ser a interpolação não resolvida (indica limpeza funcionando)
        json.previous_user_name:
          equals: "{{user_name}}"  # Deve ser a interpolação não resolvida (indica limpeza funcionando)

    capture:
      variable_state_before: "body.json"
      accessed_previous_user_id: "body.json.previous_user_id"
      accessed_previous_user_name: "body.json.previous_user_name"

  # Teste 2: Definir algumas variáveis locais neste node
  - name: "Set Local Variables in This Node"
    request:
      method: POST
      url: "/post"
      headers:
        Content-Type: "application/json"
      body:
        operation: "set_local_variables"
        node_id: "variable_cleanup_test"
        local_data:
          test_specific_var: "should_be_cleaned"
          another_local_var: "also_should_be_cleaned"
          node_identifier: "variable_cleanup_test"

    assert:
      status_code: 200

    capture:
      # Estas variáveis devem ser limpas quando mudar de node
      test_specific_var: "body.json.local_data.test_specific_var"
      another_local_var: "body.json.local_data.another_local_var"
      node_identifier: "body.json.local_data.node_identifier"
      current_timestamp: "'2024-01-01T12:00:00Z'"

  # Teste 3: Simular mudança de contexto e verificar limpeza
  - name: "Test Variable Cleanup After Node Change"
    request:
      method: GET
      url: "/get"
      headers:
        Content-Type: "application/json"
        X-Test-Context: "cleanup_verification"

    assert:
      status_code: 200

    capture:
      variable_state_after: "body.json"
      cleanup_verification_result: "'cleanup_test_completed'"
      cleanup_timestamp: "'2024-01-01T12:30:00Z'"

  # Teste 4: Verificar que apenas variáveis globais/exportadas persistem
  - name: "Verify Only Global Variables Persist"
    request:
      method: POST
      url: "/post"
      headers:
        Content-Type: "application/json"
      body:
        verification_test:
          # Estas devem estar disponíveis (globais)
          httpbin_url: "{{httpbin_url}}"

          # Estas devem estar disponíveis (exportadas do node anterior)
          previous_captured_user_data: "{{variable_interpolation.captured_user_data}}"
          previous_final_computed_value: "{{variable_interpolation.final_computed_value}}"

          # Estas NÃO devem mais estar disponíveis (eram locais do node anterior)
          should_be_cleaned_user_id: "{{user_id}}"  # Deve ser undefined/null
          should_be_cleaned_user_name: "{{user_name}}"  # Deve ser undefined/null

          # Variáveis locais deste node ainda devem estar disponíveis
          current_cleanup_var: "{{cleanup_test_var}}"
          current_local_value: "{{local_test_value}}"

    assert:
      status_code: 200
      body:
        json.verification_test.httpbin_url:
          not_null: true
        json.verification_test.current_cleanup_var:
          equals: "cleanup_value"

    capture:
      final_verification: "body.json.verification_test"
      global_variables_accessible: "body.json.verification_test.httpbin_url != null"
      exported_variables_accessible: "body.json.verification_test.previous_final_computed_value != null"

      # Estas capturas vão ajudar a verificar se a limpeza funcionou
      local_vars_cleaned_check: "body.json.verification_test.should_be_cleaned_user_id == null || body.json.verification_test.should_be_cleaned_user_id == '{{user_id}}'"
