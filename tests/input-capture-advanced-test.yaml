suite_name: "Advanced Input Capture with Transformations"
node_id: "input-capture-advanced"
description: "Demonstrates advanced step.capture with JMESPath transformations on input values"

metadata:
  priority: "high"
  tags: ["input", "capture", "jmespath", "advanced"]

variables:
  test_mode: true

exports: ["normalized_email", "email_domain", "first_name", "last_name"]

steps:
  # Example 1: Email normalization with JMESPath
  - name: "Email input with capture transformations"
    input:
      prompt: "Enter your email address:"
      variable: user_email
      type: email
      default: "John.Doe@Example.COM"
      ci_default: "John.Doe@Example.COM"
    capture:
      # Use {{js:}} for JavaScript transformations
      normalized_email: "$user_email.toLowerCase()"
      email_domain: "$user_email.split('@')[1].toLowerCase()"
      email_username: "$user_email.split('@')[0].toLowerCase()"

  # Example 2: Name splitting with capture
  - name: "Full name with capture split"
    input:
      prompt: "Enter your full name:"
      variable: full_name
      type: text
      default: "John Michael Doe"
      ci_default: "John Michael Doe"
    capture:
      # JavaScript expressions for string manipulation
      first_name: "$full_name.trim().split(' ')[0]"
      last_name: "$full_name.trim().split(' ').slice(-1)[0]"
      name_uppercase: "$full_name.toUpperCase()"
      name_length: "$full_name.length"
      initials: "$full_name.split(' ').map(n => n[0]).join('')"

  # Example 3: Number with calculations
  - name: "Age with birth year calculation"
    input:
      prompt: "Enter your age:"
      variable: user_age
      type: number
      default: 25
      ci_default: 25
    capture:
      current_year: "$new Date().getFullYear()"
      birth_year: "$new Date().getFullYear() - user_age"
      is_adult: "$user_age >= 18"
      age_category: "$user_age < 18 ? 'minor' : user_age < 65 ? 'adult' : 'senior'"

  # Example 4: Multiple inputs with combined capture
  - name: "Get country code"
    input:
      prompt: "Enter your country code (e.g., +1, +55):"
      variable: country_code
      type: text
      default: "+1"
      ci_default: "+1"
    capture:
      country_code_numeric: "$country_code.replace('+', '')"

  - name: "Get phone number"
    input:
      prompt: "Enter your phone number:"
      variable: phone_number
      type: text
      default: "5551234567"
      ci_default: "5551234567"
    capture:
      # Combine previous captures
      full_phone: "$country_code + phone_number"
      phone_formatted: "{{js: `(${phone_number.slice(0,3)}) ${phone_number.slice(3,6)}-${phone_number.slice(6)}`}}"

  # Example 5: Boolean with conditional capture
  - name: "Terms acceptance"
    input:
      prompt: "Do you accept the terms?"
      variable: terms_accepted
      type: confirm
      default: true
      ci_default: true
    capture:
      terms_status: "$terms_accepted ? 'accepted' : 'declined'"
      acceptance_timestamp: "$new Date().toISOString()"
      can_proceed: "$terms_accepted === true"

  # Example 6: Display all captured data
  - name: "Show captured summary"
    input:
      prompt: |
        Summary of Captured Data:

        Email: {{normalized_email}} (domain: {{email_domain}})
        Name: {{first_name}} {{last_name}} ({{initials}})
        Age: {{user_age}} (born in {{birth_year}})
        Phone: {{full_phone}}
        Terms: {{terms_status}}

        Press Enter to continue...
      variable: user_confirmation
      type: text
      default: "confirmed"
      ci_default: "confirmed"
    capture:
      summary_generated: "$new Date().toISOString()"
