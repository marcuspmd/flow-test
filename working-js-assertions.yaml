suite_name: "JavaScript Assertions - FUNCIONANDO"
node_id: "working-js-assertions"
base_url: "{{js: env.HTTPBIN_URL || 'http://localhost:8080'}}"

variables:
  # Use valores fixos ou interpolação simples
  min_timestamp: 1726945000000

steps:
  - name: "Teste CORRETO com JavaScript"
    request:
      method: POST
      url: "/post"
      body:
        # ✅ $js FUNCIONA aqui
        current_time: "{{$js.return Date.now()}}"
        iso_date: "{{$js.return new Date().toISOString()}}"
        random_number: "{{$js.return Math.floor(Math.random() * 1000)}}"
        user:
          age: 25
          email: "test@example.com"

    assert:
      status_code: 200

      # ✅ ASSERTIONS CUSTOMIZADAS - A FORMA MAIS PODEROSA
      custom:
        - name: "timestamp_is_recent"
          condition: "Date.now() - body.json.current_time < 10000"
          message: "Timestamp deve ser dos últimos 10 segundos"

        - name: "iso_date_format"
          condition: "/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$/.test(body.json.iso_date)"
          message: "Data ISO deve ter formato correto"

        - name: "random_in_range"
          condition: "body.json.random_number >= 0 && body.json.random_number < 1000"
          message: "Número aleatório deve estar no range 0-999"

        - name: "email_validation"
          condition: "/^[^@]+@[^@]+\\.[^@]+$/.test(body.json.user.email)"
          message: "Email deve ser válido"

        - name: "age_validation"
          condition: "body.json.user.age >= 18"
          message: "Usuário deve ser maior de idade"

        - name: "complex_logic"
          condition: "body.json.user.age > 21 || body.json.random_number > 500"
          message: "Idade > 21 OU número > 500"

  - name: "Validação de Performance com JS"
    request:
      method: GET
      url: "/delay/1"

    assert:
      status_code: 200

      custom:
        - name: "response_time_check"
          condition: "response_time >= 1000 && response_time <= 2500"
          message: "Delay de 1s deve resultar em 1-2.5s de resposta"