---
import AdminLayout from '../../layouts/AdminLayout.astro';
import CodeBlock from '../../components/CodeBlock.tsx';
import type { ReportData, SuiteResult } from '../../types/dashboard.types';
import { loadReportData } from '../../services/dataLoader';
import { withBase } from '../../utils/url';

export async function getStaticPaths() {
  const reportData = await loadReportData();
  return reportData.suites_results.map((suite) => ({
    params: { id: suite.node_id },
  }));
}

// Load real data from flow-test results
const reportData: ReportData = await loadReportData();
const { id } = Astro.params;

// Find the suite by ID
const suite = reportData.suites_results.find(s => s.node_id === id);

if (!suite) {
  return Astro.redirect(withBase('suites'));
}

// Helper functions
function getStatusIcon(status: string) {
  switch (status) {
    case 'success': return '✅';
    case 'failed': return '❌';
    case 'skipped': return '⏭️';
    default: return '❓';
  }
}

function formatDuration(ms: number): string {
  if (ms < 1000) return `${ms}ms`;
  return `${(ms / 1000).toFixed(1)}s`;
}

function formatTimestamp(timestamp: string): string {
  return new Date(timestamp).toLocaleString('pt-BR');
}

function getPriorityColor(priority: string) {
  switch (priority) {
    case 'critical': return 'badge-error';
    case 'high': return 'badge-warning';
    case 'medium': return 'badge-info';
    case 'low': return 'badge-success';
    default: return 'badge-ghost';
  }
}

// Calculate suite statistics
const totalSteps = suite.steps_results.length;
const successfulSteps = suite.steps_results.filter(s => s.status === 'success').length;
const failedSteps = suite.steps_results.filter(s => s.status === 'failed').length;
const skippedSteps = suite.steps_results.filter(s => s.status === 'skipped').length;
const successRate = totalSteps > 0 ? Math.round((successfulSteps / totalSteps) * 100) : 0;

// Group steps by type for better organization
const requestSteps = suite.steps_results.filter(s => s.request_details && s.request_details.method);
const flowSteps = suite.steps_results.filter(s => !s.request_details || !s.request_details.method);

// Identify iteration steps
const iterationSteps = suite.steps_results.filter(s => s.iteration_results && s.iteration_results.length > 0);
const totalIterations = iterationSteps.reduce((acc, step) => acc + (step.iteration_results?.length || 0), 0);
---

<AdminLayout title={`Suite: ${suite.suite_name}`} reportData={reportData}>
  <!-- Breadcrumb -->
  <div class="breadcrumbs text-sm mb-6">
    <ul>
      <li><a href={withBase('/')} class="hover:text-primary">Dashboard</a></li>
      <li><a href={withBase('suites')} class="hover:text-primary">Test Suites</a></li>
      <li class="text-base-content/70">{suite.suite_name}</li>
    </ul>
  </div>

  <!-- Suite Header -->
  <div class="hero bg-base-200 rounded-box mb-8">
    <div class="hero-content text-center">
      <div class="max-w-4xl">
        <div class="flex items-center justify-center gap-3 mb-4">
          <span class="text-4xl">{getStatusIcon(suite.status)}</span>
          <h1 class="text-4xl font-bold text-base-content">{suite.suite_name}</h1>
        </div>

        <p class="text-base-content/70 mb-4 text-lg">
          {suite.file_path}
        </p>

        <div class="flex flex-wrap justify-center gap-4">
          <div class={`badge badge-lg ${getPriorityColor(suite.priority)}`}>
            {suite.priority}
          </div>
          <div class="badge badge-lg badge-outline">
            {totalSteps} Steps
          </div>
          <div class="badge badge-lg badge-outline">
            Duration: {formatDuration(suite.duration_ms)}
          </div>
          <div class="badge badge-lg badge-outline">
            Success Rate: {successRate}%
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Suite Metadata -->
  {(suite.description || suite.metadata) && (
    <div class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-2xl">📋</span>
          <h2 class="card-title">Metadados da Suite</h2>
        </div>

        {suite.description && (
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">Descrição</h3>
            <p class="text-base-content/80 bg-base-200/50 rounded-lg px-4 py-3">
              {suite.description}
            </p>
          </div>
        )}

        {suite.metadata && (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {suite.metadata.description && suite.metadata.description !== suite.description && (
              <div class="space-y-2">
                <h4 class="font-semibold text-sm text-base-content/60 uppercase tracking-wide">
                  Descrição Adicional
                </h4>
                <p class="text-sm bg-base-200/50 rounded px-3 py-2">
                  {suite.metadata.description}
                </p>
              </div>
            )}

            {suite.metadata.tags && suite.metadata.tags.length > 0 && (
              <div class="space-y-2">
                <h4 class="font-semibold text-sm text-base-content/60 uppercase tracking-wide">
                  Tags
                </h4>
                <div class="flex flex-wrap gap-2">
                  {suite.metadata.tags.map((tag: string) => (
                    <span class="badge badge-outline badge-sm">{tag}</span>
                  ))}
                </div>
              </div>
            )}

            {suite.metadata.priority && (
              <div class="space-y-2">
                <h4 class="font-semibold text-sm text-base-content/60 uppercase tracking-wide">
                  Prioridade Definida
                </h4>
                <div class={`badge ${getPriorityColor(suite.metadata.priority)}`}>
                  {suite.metadata.priority}
                </div>
              </div>
            )}

            {suite.metadata.estimated_duration_ms && (
              <div class="space-y-2">
                <h4 class="font-semibold text-sm text-base-content/60 uppercase tracking-wide">
                  Duração Estimada
                </h4>
                <div class="text-sm bg-info/10 border border-info/20 rounded px-3 py-2">
                  <span class="font-mono">{formatDuration(suite.metadata.estimated_duration_ms)}</span>
                  <span class="text-xs text-base-content/60 ml-2">
                    (Real: {formatDuration(suite.duration_ms)})
                  </span>
                </div>
              </div>
            )}

            {suite.metadata.timeout && (
              <div class="space-y-2">
                <h4 class="font-semibold text-sm text-base-content/60 uppercase tracking-wide">
                  Timeout Configurado
                </h4>
                <div class="text-sm bg-warning/10 border border-warning/20 rounded px-3 py-2">
                  <span class="font-mono">{formatDuration(suite.metadata.timeout)}</span>
                </div>
              </div>
            )}

            {(!suite.metadata.tags || suite.metadata.tags.length === 0) &&
             !suite.metadata.estimated_duration_ms &&
             !suite.metadata.timeout &&
             !suite.metadata.description && (
              <div class="col-span-full text-center py-4">
                <div class="text-2xl mb-2">📝</div>
                <p class="text-base-content/60 text-sm">
                  Esta suite não possui metadados adicionais configurados
                </p>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  )}

  <!-- Suite Statistics -->
  <div class="stats stats-vertical lg:stats-horizontal shadow mb-8 w-full">
    <div class="stat">
      <div class="stat-figure text-success">
        <span class="text-2xl">✅</span>
      </div>
      <div class="stat-title">Successful Steps</div>
      <div class="stat-value text-success">{successfulSteps}</div>
      <div class="stat-desc">{successRate}% success rate</div>
    </div>

    <div class="stat">
      <div class="stat-figure text-error">
        <span class="text-2xl">❌</span>
      </div>
      <div class="stat-title">Failed Steps</div>
      <div class="stat-value text-error">{failedSteps}</div>
      <div class="stat-desc">{totalSteps > 0 ? Math.round((failedSteps / totalSteps) * 100) : 0}% of total</div>
    </div>

    <div class="stat">
      <div class="stat-figure text-warning">
        <span class="text-2xl">⏭️</span>
      </div>
      <div class="stat-title">Skipped Steps</div>
      <div class="stat-value text-warning">{skippedSteps}</div>
      <div class="stat-desc">{totalSteps > 0 ? Math.round((skippedSteps / totalSteps) * 100) : 0}% of total</div>
    </div>

    <div class="stat">
      <div class="stat-figure text-info">
        <span class="text-2xl">🔗</span>
      </div>
      <div class="stat-title">HTTP Requests</div>
      <div class="stat-value text-info">{requestSteps.length}</div>
      <div class="stat-desc">{Math.round((requestSteps.length / totalSteps) * 100)}% requests</div>
    </div>

    <div class="stat">
      <div class="stat-figure text-primary">
        <span class="text-2xl">🔄</span>
      </div>
      <div class="stat-title">Iterações</div>
      <div class="stat-value text-primary">{totalIterations}</div>
      <div class="stat-desc">{iterationSteps.length} steps com iterações</div>
    </div>
  </div>

  <!-- Execution Timeline -->
  <div class="card bg-base-100 shadow-lg mb-8">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-4">📊 Execution Timeline</h2>

      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th class="w-12">#</th>
              <th class="w-16">Status</th>
              <th>Step Name</th>
              <th class="w-20">Type</th>
              <th class="w-24">Duration</th>
              <th class="w-32">Started At</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {suite.steps_results.map((step, index) => (
              <tr>
                <td class="text-center font-mono">{index + 1}</td>
                <td class="text-center text-xl">{getStatusIcon(step.status)}</td>
                <td>
                  <div class="font-semibold">{step.step_name}</div>
                  {step.request_details && (
                    <div class="text-sm text-base-content/70">
                      {step.request_details.method} {step.request_details.url}
                    </div>
                  )}
                </td>
                <td>
                  <div class="badge badge-outline badge-sm">
                    {step.request_details ? 'request' : 'flow'}
                  </div>
                </td>
                <td class="font-mono text-sm">{formatDuration(step.duration_ms)}</td>
                <td class="font-mono text-xs">{formatTimestamp(suite.start_time)}</td>
                <td>
                  {!step.assertions_results.every(a => a.passed) && (
                    <div class="alert alert-error alert-sm p-2 text-xs">
                      <span class="text-xs">❌ Assertion failed</span>
                    </div>
                  )}
                  {step.status === 'success' && step.request_details && (
                    <div class="text-success text-xs">
                      ✅ Request completed successfully
                    </div>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- HTTP Requests Details -->
  {requestSteps.length > 0 && (
    <div class="card bg-base-100 shadow-lg mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">🌐 HTTP Requests Debug Info</h2>

        <div class="space-y-6">
          {requestSteps.map((step, index) => (
            <div class="card bg-base-200 shadow">
              <div class="card-body">
                <div class="flex justify-between items-start mb-4">
                  <div class="flex items-center gap-3">
                    <span class="text-xl">{getStatusIcon(step.status)}</span>
                    <div>
                      <h3 class="font-bold text-lg">{step.step_name}</h3>
                      <p class="text-sm text-base-content/70">Step #{index + 1}</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="badge badge-outline">{formatDuration(step.duration_ms)}</div>
                  </div>
                </div>
                <div>
                  <CodeBlock
                    client:load
                    code={step.request_details.curl_command}
                    language="bash"
                    title="cURL Command"
                    maxHeight="150px"
                  />
                </div>
                <!-- Request Details -->
                {step.request_details && (
                  <div class="grid lg:grid-cols-2 gap-4 mb-4">
                    <div class="card bg-base-100 p-4">
                      <h4 class="font-semibold mb-2 text-info">📤 Request</h4>
                      <div class="space-y-2 text-sm">
                        <div><strong>Method:</strong>
                          <span class="badge badge-sm ml-2 font-mono">{step.request_details.method}</span>
                        </div>
                        <div><strong>URL:</strong>
                          <code class="text-xs bg-base-200 px-2 py-1 rounded ml-2 break-all">
                            {step.request_details.full_url}
                          </code>
                        </div>
                        <div><strong>Base URL:</strong>
                          <code class="text-xs bg-base-200 px-2 py-1 rounded ml-2">
                            {step.request_details.base_url}
                          </code>
                        </div>
                        {step.request_details.headers && Object.keys(step.request_details.headers).length > 0 && (
                          <div>
                            <CodeBlock
                              client:load
                              code={Object.entries(step.request_details.headers).map(([key, value]) => `${key}: ${value}`).join('\n')}
                              language="http"
                              title="Request Headers"
                              maxHeight="200px"
                            />
                          </div>
                        )}
                        {step.request_details.body && (
                          <div>
                            <CodeBlock
                              client:load
                              code={typeof step.request_details.body === 'string' ? step.request_details.body : JSON.stringify(step.request_details.body, null, 2)}
                              language="json"
                              title="Request Body"
                              maxHeight="300px"
                            />
                          </div>
                        )}

                      </div>
                    </div>

                    <!-- Response Details -->
                    {step.response_details && (
                      <div class="card bg-base-100 p-4">
                        <h4 class="font-semibold mb-2 text-success">📥 Response</h4>
                        <div class="space-y-2 text-sm">
                          <div><strong>Status Code:</strong>
                            <span class="badge badge-sm ml-2 font-mono">{step.response_details.status_code}</span>
                          </div>
                          <div><strong>Duration:</strong>
                            <span class="font-mono ml-2">{formatDuration(step.duration_ms)}</span>
                          </div>
                          <div><strong>Size:</strong>
                            <span class="font-mono ml-2">{step.response_details.size_bytes} bytes</span>
                          </div>
                          {step.response_details.headers && Object.keys(step.response_details.headers).length > 0 && (
                            <div>
                              <CodeBlock
                                client:load
                                code={Object.entries(step.response_details.headers).map(([key, value]) => `${key}: ${value}`).join('\n')}
                                language="http"
                                title="Response Headers"
                                maxHeight="200px"
                              />
                            </div>
                          )}
                          {step.response_details.body && (
                            <div>
                              <CodeBlock
                                client:load
                                code={typeof step.response_details.body === 'string' ? step.response_details.body : JSON.stringify(step.response_details.body, null, 2)}
                                language="json"
                                title="Response Body"
                                maxHeight="400px"
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                <!-- Assertions Results -->
                {step.assertions_results && step.assertions_results.length > 0 && (
                  <div class="mt-4">
                    {(() => {
                      const total = step.assertions_results.length;
                      const passed = step.assertions_results.filter(a => a.passed).length;
                      const failed = total - passed;
                      const successRate = total > 0 ? Math.round((passed / total) * 100) : 0;

                      return (
                        <div>
                          <!-- Stats Header -->
                          <div class="stats stats-vertical lg:stats-horizontal shadow bg-base-100 w-full mb-4">
                            <div class="stat">
                              <div class="stat-figure text-primary">
                                <span class="text-lg">📊</span>
                              </div>
                              <div class="stat-title text-xs">Total</div>
                              <div class="stat-value text-sm text-primary">{total}</div>
                              <div class="stat-desc text-xs">assertions</div>
                            </div>

                            <div class="stat">
                              <div class="stat-figure text-success">
                                <span class="text-lg">✅</span>
                              </div>
                              <div class="stat-title text-xs">Passed</div>
                              <div class="stat-value text-sm text-success">{passed}</div>
                              <div class="stat-desc text-xs">{passed === 1 ? 'assertion' : 'assertions'}</div>
                            </div>

                            {failed > 0 && (
                              <div class="stat">
                                <div class="stat-figure text-error">
                                  <span class="text-lg">❌</span>
                                </div>
                                <div class="stat-title text-xs">Failed</div>
                                <div class="stat-value text-sm text-error">{failed}</div>
                                <div class="stat-desc text-xs">{failed === 1 ? 'assertion' : 'assertions'}</div>
                              </div>
                            )}

                            <div class="stat">
                              <div class="stat-figure text-info">
                                <span class="text-lg">📈</span>
                              </div>
                              <div class="stat-title text-xs">Success Rate</div>
                              <div class={`stat-value text-sm ${successRate === 100 ? 'text-success' : successRate >= 80 ? 'text-warning' : 'text-error'}`}>
                                {successRate}%
                              </div>
                              <div class="stat-desc text-xs">success</div>
                            </div>
                          </div>

                          <!-- Assertion Details -->
                          <div class="space-y-2">
                            {step.assertions_results.map((assertion, idx) => {
                              const isEqual = JSON.stringify(assertion.expected) === JSON.stringify(assertion.actual);
                              const failedCount = step.assertions_results.filter(a => !a.passed).length;
                              const shouldShowDetails = !assertion.passed || failedCount < 3;

                              return (
                                <div class={`rounded-lg border-2 p-4 mb-3 transition-all duration-200 hover:shadow-md ${
                                  assertion.passed
                                    ? 'bg-success/5 border-success/30 hover:bg-success/10'
                                    : 'bg-error/5 border-error/30 hover:bg-error/10'
                                }`}>
                                  {/* Header com status e campo */}
                                  <div class="flex items-start justify-between gap-4 mb-3">
                                    <div class="flex items-center gap-3">
                                      <div class={`flex items-center justify-center w-8 h-8 rounded-full text-lg font-bold ${
                                        assertion.passed
                                          ? 'bg-success text-success-content'
                                          : 'bg-error text-error-content'
                                      }`}>
                                        {assertion.passed ? '✓' : '✗'}
                                      </div>
                                      <div>
                                        <h4 class="font-semibold text-base text-base-content">{assertion.field}</h4>
                                        <div class="flex items-center gap-2 mt-1">
                                          <span class={`badge badge-sm font-medium ${
                                            assertion.passed ? 'badge-success' : 'badge-error'
                                          }`}>
                                            {assertion.passed ? 'PASSED' : 'FAILED'}
                                          </span>
                                          {assertion.operator && (
                                            <span class="badge badge-outline badge-sm font-mono">
                                              {assertion.operator}
                                            </span>
                                          )}
                                        </div>
                                      </div>
                                    </div>

                                    {assertion.passed && isEqual && (
                                      <div class="flex items-center gap-2">
                                        <span class="text-sm text-success font-medium">✓ Match</span>
                                      </div>
                                    )}
                                  </div>

                                  {/* Condição da assertion */}
                                  <div class="bg-base-100 rounded-lg p-3 mb-3">
                                    <div class="text-xs font-medium text-base-content/60 mb-2 uppercase tracking-wide">
                                      Condição
                                    </div>
                                    <div class="text-sm font-mono bg-base-200 rounded px-3 py-2">
                                      <span class="text-primary font-semibold">{assertion.field}</span>
                                      <span class="text-base-content/70 mx-2">{assertion.operator || 'equals'}</span>
                                      <span class="text-secondary font-semibold">
                                        {typeof assertion.expected === 'object'
                                          ? JSON.stringify(assertion.expected)
                                          : assertion.expected}
                                      </span>
                                    </div>
                                  </div>

                                  {/* Detalhes dos valores */}
                                  {(shouldShowDetails && !isEqual) || !assertion.passed ? (
                                    <div class="space-y-4">
                                      <div class="divider my-2">Comparação de Valores</div>
                                      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                          <div class="flex items-center gap-2">
                                            <span class="text-sm font-semibold text-info">Esperado</span>
                                            <span class="badge badge-info badge-xs">expected</span>
                                          </div>
                                          {typeof assertion.expected === 'object' ? (
                                            <CodeBlock
                                              client:load
                                              code={JSON.stringify(assertion.expected, null, 2)}
                                              language="json"
                                              title=""
                                              maxHeight="150px"
                                            />
                                          ) : (
                                            <div class="bg-info/10 border border-info/20 rounded-lg px-3 py-2">
                                              <div class="text-sm font-mono text-info-content break-all">
                                                {String(assertion.expected)}
                                              </div>
                                            </div>
                                          )}
                                        </div>

                                        <div class="space-y-2">
                                          <div class="flex items-center gap-2">
                                            <span class="text-sm font-semibold text-warning">Recebido</span>
                                            <span class="badge badge-warning badge-xs">actual</span>
                                          </div>
                                          {typeof assertion.actual === 'object' ? (
                                            <CodeBlock
                                              client:load
                                              code={JSON.stringify(assertion.actual, null, 2)}
                                              language="json"
                                              title=""
                                              maxHeight="150px"
                                            />
                                          ) : (
                                            <div class="bg-warning/10 border border-warning/20 rounded-lg px-3 py-2">
                                              <div class="text-sm font-mono text-warning-content break-all">
                                                {String(assertion.actual)}
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  ) : assertion.passed && isEqual ? (
                                    <div class="bg-base-100 border border-success/20 rounded-lg p-3">
                                      <div class="flex items-center gap-2 text-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-sm font-medium">Assertion passou conforme esperado</span>
                                      </div>
                                      <div class="text-sm text-secondary mt-1">
                                        Valor recebido: <span class="font-mono font-bold px-1 rounded">
                                          {typeof assertion.actual === 'object' ? 'Objeto/Array' : String(assertion.actual)}
                                        </span>
                                      </div>
                                    </div>
                                  ) : null}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                )}

                <!-- Variables and Context -->
                {step.captured_variables && Object.keys(step.captured_variables).length > 0 && (
                  <div class="mt-4">
                    <CodeBlock
                      client:load
                      code={JSON.stringify(step.captured_variables, null, 2)}
                      language="json"
                      title="Captured Variables"
                      maxHeight="200px"
                    />
                  </div>
                )}

                <!-- Available Variables -->
                {step.available_variables && Object.keys(step.available_variables).length > 0 && (
                  <div class="mt-4">
                    <CodeBlock
                      client:load
                      code={JSON.stringify(step.available_variables, null, 2)}
                      language="json"
                      title="Available Variables"
                      maxHeight="200px"
                    />
                  </div>
                )}

                <!-- Scenarios Metadata -->
                {step.scenarios_meta && step.scenarios_meta.has_scenarios && (
                  <div class="mt-4">
                    <h4 class="font-semibold mb-2 text-purple-600">🎭 Scenarios</h4>
                    <div class="space-y-2">
                      <div class="text-sm">
                        <strong>Executed:</strong> {step.scenarios_meta.executed_count} scenarios
                      </div>
                      {step.scenarios_meta.evaluations && step.scenarios_meta.evaluations.length > 0 && (
                        <div class="space-y-1">
                          {step.scenarios_meta.evaluations.map((evaluation, idx) => (
                            <div class={`badge badge-sm ${evaluation.executed ? 'badge-success' : 'badge-outline'}`}>
                              Scenario {evaluation.index}: {evaluation.branch}
                              {evaluation.executed ? '✓' : '○'}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Iteration Tests Detail -->
  {iterationSteps.length > 0 && (
    <div class="card bg-base-100 shadow-lg mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">🔄 Iteration Tests - Detailed Breakdown</h2>
        <div class="alert alert-info mb-4">
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <span>
              <strong>{totalIterations} iterações</strong> executadas em {iterationSteps.length} steps de teste.
              Cada iteração mostra request/response detalhados com URL, cURL e resultados específicos.
            </span>
          </div>
        </div>

        <div class="space-y-8">
          {iterationSteps.map((step, stepIndex) => (
            <div class="card bg-base-200 shadow-lg">
              <div class="card-body">
                <div class="flex justify-between items-start mb-6">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">{getStatusIcon(step.status)}</span>
                    <div>
                      <h3 class="font-bold text-xl">{step.step_name}</h3>
                      <p class="text-sm text-base-content/70">
                        {step.iteration_results?.length || 0} iterações • Duration total: {formatDuration(step.duration_ms)}
                      </p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="badge badge-lg badge-outline">Step #{stepIndex + 1}</div>
                  </div>
                </div>

                <!-- Iteration Results -->
                {step.iteration_results && (
                  <div class="space-y-6">
                    <h4 class="font-semibold text-lg text-primary mb-4">🎯 Iterações Executadas:</h4>

                    {step.iteration_results.map((iteration, iterIndex) => (
                      <div class="card bg-base-100 shadow border-l-4 border-l-primary">
                        <div class="card-body">
                          <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                              <span class="text-lg">{getStatusIcon(iteration.status)}</span>
                              <div>
                                <h5 class="font-bold text-base">{iteration.step_name}</h5>
                                <p class="text-xs text-base-content/70">
                                  Iteração {iterIndex + 1} de {step.iteration_results?.length || 0} • {formatDuration(iteration.duration_ms)}
                                </p>
                              </div>
                            </div>
                            <div class="badge badge-outline badge-sm">#{iterIndex + 1}</div>
                          </div>

                          <!-- Iteration Request/Response Details -->
                          {iteration.request_details && (
                            <div class="grid lg:grid-cols-2 gap-4 mb-4">
                              <div class="card bg-base-200 p-4">
                                <h6 class="font-semibold mb-3 text-info">📤 Request Iteration #{iterIndex + 1}</h6>
                                <div class="space-y-3 text-sm">
                                  <div><strong>Method:</strong>
                                    <span class="badge badge-sm ml-2 font-mono">{iteration.request_details.method}</span>
                                  </div>
                                  <div><strong>URL:</strong>
                                    <code class="text-xs bg-base-300 px-2 py-1 rounded ml-2 break-all block mt-1">
                                      {iteration.request_details.full_url}
                                    </code>
                                  </div>
                                  <div><strong>Base URL:</strong>
                                    <code class="text-xs bg-base-300 px-2 py-1 rounded ml-2">
                                      {iteration.request_details.base_url}
                                    </code>
                                  </div>

                                  {iteration.request_details.headers && Object.keys(iteration.request_details.headers).length > 0 && (
                                    <div>
                                      <CodeBlock
                                        client:load
                                        code={Object.entries(iteration.request_details.headers).map(([key, value]) => `${key}: ${value}`).join('\n')}
                                        language="http"
                                        title={`Request Headers - Iteração ${iterIndex + 1}`}
                                        maxHeight="150px"
                                      />
                                    </div>
                                  )}

                                  {iteration.request_details.body && (
                                    <div>
                                      <CodeBlock
                                        client:load
                                        code={typeof iteration.request_details.body === 'string' ? iteration.request_details.body : JSON.stringify(iteration.request_details.body, null, 2)}
                                        language="json"
                                        title={`Request Body - Iteração ${iterIndex + 1}`}
                                        maxHeight="200px"
                                      />
                                    </div>
                                  )}

                                  <div>
                                    <CodeBlock
                                      client:load
                                      code={iteration.request_details.curl_command}
                                      language="bash"
                                      title={`cURL Command - Iteração ${iterIndex + 1}`}
                                      maxHeight="100px"
                                    />
                                  </div>
                                </div>
                              </div>

                              <!-- Response Details -->
                              {iteration.response_details && (
                                <div class="card bg-base-200 p-4">
                                  <h6 class="font-semibold mb-3 text-success">📥 Response Iteration #{iterIndex + 1}</h6>
                                  <div class="space-y-3 text-sm">
                                    <div><strong>Status Code:</strong>
                                      <span class="badge badge-sm ml-2 font-mono">{iteration.response_details.status_code}</span>
                                    </div>
                                    <div><strong>Duration:</strong>
                                      <span class="font-mono ml-2">{formatDuration(iteration.duration_ms)}</span>
                                    </div>
                                    <div><strong>Size:</strong>
                                      <span class="font-mono ml-2">{iteration.response_details.size_bytes} bytes</span>
                                    </div>

                                    {iteration.response_details.headers && Object.keys(iteration.response_details.headers).length > 0 && (
                                      <div>
                                        <CodeBlock
                                          client:load
                                          code={Object.entries(iteration.response_details.headers).map(([key, value]) => `${key}: ${value}`).join('\n')}
                                          language="http"
                                          title={`Response Headers - Iteração ${iterIndex + 1}`}
                                          maxHeight="150px"
                                        />
                                      </div>
                                    )}

                                    {iteration.response_details.body && (
                                      <div>
                                        <CodeBlock
                                          client:load
                                          code={typeof iteration.response_details.body === 'string' ? iteration.response_details.body : JSON.stringify(iteration.response_details.body, null, 2)}
                                          language="json"
                                          title={`Response Body - Iteração ${iterIndex + 1}`}
                                          maxHeight="300px"
                                        />
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}
                            </div>
                          )}

                          <!-- Iteration Assertions -->
                          {iteration.assertions_results && iteration.assertions_results.length > 0 && (
                            <div class="mt-4">
                              <h6 class="font-semibold mb-3 text-warning flex items-center gap-2">
                                🔍 Assertions - Iteração #{iterIndex + 1}
                                <span class="badge badge-sm badge-neutral">{iteration.assertions_results.length}</span>
                              </h6>

                              <div class="space-y-2">
                                {iteration.assertions_results.map((assertion, assertIndex) => {
                                  const isEqual = JSON.stringify(assertion.expected) === JSON.stringify(assertion.actual);

                                  return (
                                    <div class={`rounded-lg border p-2 ${
                                      assertion.passed
                                        ? 'bg-success/5 border-success/20'
                                        : 'bg-error/10 border-error/30'
                                    }`}>
                                      <div class="flex items-start gap-2">
                                        <span class={`text-sm ${assertion.passed ? 'text-success' : 'text-error'}`}>
                                          {assertion.passed ? '✅' : '❌'}
                                        </span>

                                        <div class="flex-1 min-w-0">
                                          <div class="flex items-center gap-2 mb-1">
                                            <span class="font-medium text-xs">{assertion.field}</span>
                                            {assertion.passed && isEqual && (
                                              <span class="text-xs text-success bg-success/10 px-1 py-0.5 rounded">
                                                {typeof assertion.actual === 'object' ? 'OK' : assertion.actual} ✓
                                              </span>
                                            )}
                                          </div>

                                          {assertion.message && (
                                            <p class="text-xs text-base-content/70 mb-1">{assertion.message}</p>
                                          )}

                                          {!assertion.passed && !isEqual && (
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 mt-1">
                                              <div>
                                                <div class="text-xs font-medium text-base-content/60 mb-1">Expected:</div>
                                                {typeof assertion.expected === 'object' ? (
                                                  <CodeBlock
                                                    client:load
                                                    code={JSON.stringify(assertion.expected, null, 2)}
                                                    language="json"
                                                    title=""
                                                    maxHeight="80px"
                                                  />
                                                ) : (
                                                  <div class="bg-base-200 rounded px-2 py-1 text-xs font-mono">
                                                    {assertion.expected}
                                                  </div>
                                                )}
                                              </div>

                                              <div>
                                                <div class="text-xs font-medium text-base-content/60 mb-1">Actual:</div>
                                                {typeof assertion.actual === 'object' ? (
                                                  <CodeBlock
                                                    client:load
                                                    code={JSON.stringify(assertion.actual, null, 2)}
                                                    language="json"
                                                    title=""
                                                    maxHeight="80px"
                                                  />
                                                ) : (
                                                  <div class="bg-base-200 rounded px-2 py-1 text-xs font-mono">
                                                    {assertion.actual}
                                                  </div>
                                                )}
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          )}

                          <!-- Iteration Variables -->
                          {iteration.captured_variables && Object.keys(iteration.captured_variables).length > 0 && (
                            <div class="mt-4">
                              <CodeBlock
                                client:load
                                code={JSON.stringify(iteration.captured_variables, null, 2)}
                                language="json"
                                title={`Captured Variables - Iteração ${iterIndex + 1}`}
                                maxHeight="150px"
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Flow and Other Steps -->
  {flowSteps.length > 0 && (
    <div class="card bg-base-100 shadow-lg mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">🔄 Flow & Other Steps</h2>

        <div class="space-y-4">
          {flowSteps.map((step, index) => (
            <div class="card bg-base-200 shadow-sm">
              <div class="card-body p-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-3">
                    <span class="text-xl">{getStatusIcon(step.status)}</span>
                    <div>
                      <h3 class="font-semibold">{step.step_name}</h3>
                      <p class="text-sm text-base-content/70">
                        Type: flow • Duration: {formatDuration(step.duration_ms)}
                      </p>
                    </div>
                  </div>
                </div>

                {step.assertions_results && !step.assertions_results.every(a => a.passed) && (
                  <div class="alert alert-error alert-sm mt-2">
                    <span class="text-xs">Assertion failed</span>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Raw Suite Data -->
  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-4">📄 Raw Suite Data</h2>
      <CodeBlock
        client:load
        code={JSON.stringify(suite, null, 2)}
        language="json"
        title="Complete Suite Data"
        maxHeight="500px"
      />
    </div>
  </div>
</AdminLayout>
